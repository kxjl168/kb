<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kxjl.admin.persistence.adapter.dao.KgRelationMapperAdapter">
    <resultMap id="BaseResultMap"
               type="com.kxjl.admin.persistence.entity.KgRelation"
               extends="com.kxjl.admin.persistence.dao.KgRelationMapper.BaseResultMap">
    </resultMap>
    
    <resultMap id="PropertyResultMap"
               type="com.kxjl.admin.persistence.entity.KgProperty"
               extends="com.kxjl.admin.persistence.dao.KgPropertyMapper.BaseResultMap">
    </resultMap>
     <!--在此编写自己的sql, 生成的sql文件不需要编辑，分开管理-->


	<select id="selectByName"
		parameterType="com.kxjl.admin.persistence.entity.KgRelation"
		resultMap="BaseResultMap">
		select
		c.*
		from KG_RELATION c
		<!-- left join KG_CLASS k on c.CLS_ID=k.ID -->


		where 1=1 and c.deleted='0'

		<if test="name != null and name!='' ">

			AND c.NAME= #{name}

		</if>

<if test="_databaseId =='oracle' " >
			<![CDATA[ and  rownum<=1 ]]> 
		</if>
		
	
	order by c.CREATED_TIME DESC
	
	<if test="_databaseId =='mysql' " >
		<![CDATA[ 
		limit 1 
		]]>
		</if>
	</select>
    
    <sql id="selectAllRelationTable">

		(
		select  c.ID, c.VERSION_ID, c.NAME, c.EQUIVALENCE, c.REVERSE, c.TRANSITIVITY, c.SYMMETRY, c.REMARK, c.ENABLED, 
    c.DELETED, c.CREATED_USER, c.CREATED_TIME, c.UPDATED_USER, c.UPDATED_TIME
		from KG_RELATION c
	<!-- 	<if test="curUser != null and curUser!='' "> -->
			UNION all
			(
			select c.ID, c.VERSION_ID, c.NAME, c.EQUIVALENCE, c.REVERSE, c.TRANSITIVITY, c.SYMMETRY, c.REMARK, c.ENABLED, 
    c.DELETED, c.CREATED_USER, c.CREATED_TIME, c.UPDATED_USER, c.UPDATED_TIME
			from
			KG_EDIT_RELATION c
			left join kg_edit_data e on c.id=e.edit_data_id
			where
			1=1 
			<!-- and e.edit_user=#{curUser} -->
			and e.edit_action='1'
and e.audit_state in ('1','2') 
			)

		<!-- </if> -->
		)
	</sql>
    
    <sql id="selectAllPropertyTable">

		(
		select c.ID, c.VERSION_ID, c.NAME, c.DATA_TYPE_RULE, c.EQUIVALENCE,
		c.REMARK, c.ENABLED, c.DELETED, c.CREATED_USER,
		c.CREATED_TIME,
		c.UPDATED_USER, c.UPDATED_TIME from
		KG_PROPERTY c
		<if test="curUser != null and curUser!='' ">
			union
			(
			select c.ID, c.VERSION_ID, c.NAME, c.DATA_TYPE_RULE,
			c.EQUIVALENCE,
			c.REMARK, c.ENABLED, c.DELETED, c.CREATED_USER,
			c.CREATED_TIME, c.UPDATED_USER, c.UPDATED_TIME from
			KG_EDIT_PROPERTY c
			left join kg_edit_data e on c.id=e.edit_data_id
			where 1=1 and
			e.edit_user=#{curUser}
			and e.edit_action='1'
			and e.audit_state in ('1','2') 
			)
		</if>
		)

	</sql>
    
      <select id="selectList"
		parameterType="com.kxjl.admin.persistence.entity.KgRelation"
		resultMap="BaseResultMap">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Mon Jun 08 
			11:51:06 CST 2020. -->
	
select
	
    c.ID, c.VERSION_ID, c.NAME, c.EQUIVALENCE, c.REVERSE, c.TRANSITIVITY, c.SYMMETRY, c.REMARK, c.ENABLED, 
    c.DELETED, c.CREATED_USER, c.CREATED_TIME, c.UPDATED_USER, c.UPDATED_TIME,

tp.attrNames,tp.attrIds attrs
		from 	<include refid="selectAllRelationTable" />  c
		
			left join (
			
			
	<if test="_databaseId =='oracle' " >
				select id tid,max(attrNames) attrNames, max(attrIds) attrIds from (
select  c.id ,WMSYS.WM_CONCAT (kp.name) over(partition by c.id order by c.id) attrNames,
WMSYS.WM_CONCAT(kp.id) over(partition by c.id order by c.id) attrIds 
from <include refid="selectAllRelationTable" />  c
left join KG_OBJECT_PROPERTY op on c.id=op.relation_id
left join <include refid="selectAllPropertyTable" /> kp on op.prop_id=kp.id
) c
group by c.id
</if>


<if test="_databaseId =='mysql' " >
select id tid,GROUP_CONCAT(tp.name order by tp.kid) attrNames,GROUP_CONCAT(tp.kid order by tp.kid)
		attrIds from (
	
		select c.id,kp.name,kp.id kid
		FROM
		<include refid="selectAllRelationTable" />
		c
		LEFT JOIN KG_OBJECT_PROPERTY op ON c. ID = op.cls_id
		LEFT JOIN
		<include refid="selectAllPropertyTable" />
		kp ON op.prop_id = kp. ID
	
		) tp where 1=1 group by id
</if>


	) tp on c.id=tp.tid

	where 1=1 and c.deleted='0'
		<if test="name != null and name!='' ">
			<bind name="name" value="'%' + name + '%'" />
			AND c.NAME LIKE #{name}

		</if>
		
		
		<if test="id != null and id!='' ">
		
			AND c.id = #{id}

		</if>
		
		order by   c.CREATED_TIME DESC 
		</select>
		
		
      <select id="getProperty" parameterType="com.kxjl.admin.persistence.entity.KgProperty"
		resultMap="PropertyResultMap">
		
		select kp.*
		
		 from KG_RELATION c
left join KG_OBJECT_PROPERTY op on c.id=op.relation_id
left join KG_PROPERTY kp on op.prop_id=kp.id
where 1=1
and  kp.id is not null
and kp.deleted='0'
and c.id=#{id}



		
		 </select>
    

</mapper>