<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kxjl.admin.persistence.adapter.dao.KgDataAuditLogMapperAdapter">
    <resultMap id="BaseResultMap"
               type="com.kxjl.admin.persistence.entity.KgDataAuditLog"
               extends="com.kxjl.admin.persistence.dao.KgDataAuditLogMapper.BaseResultMap">
    </resultMap>
    
    
      <resultMap id="EdataBaseResultMap"
               type="com.kxjl.admin.persistence.entity.KgEditData"
               extends="com.kxjl.admin.persistence.dao.KgEditDataMapper.BaseResultMap">
    </resultMap>
    
    
     <!--在此编写自己的sql, 生成的sql文件不需要编辑-->


    
    <select id="getEdataByAuditRstId" parameterType="com.kxjl.admin.persistence.entity.KgDataAuditLog" resultMap="EdataBaseResultMap">
    select edata.* from KG_DATA_AUDIT_LOG log left join KG_DATA_AUDIT_DETAIL detail on  log.id=detail.data_audit_id
left join KG_EDIT_DATA edata on detail.data_edit_id=edata.id
where log.audit_rst_id=#{auditRstId}
    </select>
    
    
	<select id="selectList" databaseId="oracle"
		parameterType="com.kxjl.admin.persistence.entity.KgDataAuditLog"
		resultMap="BaseResultMap">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Mon Jun 08 
			11:51:06 CST 2020. -->
	
	
		select c.*,tp2.* from KG_data_audit_log c
			
			left join (
			
			select id tid,max(edit_date) editUserDate,max(user_name) editUserName,max(edit_user) editUser,max(edit_action) editAction,max(edit_data_id) editDataId,max(data_Type) dataType from (

select tp1.*,tp2.edit_data_id,tp2.user_name ,tp3.edit_user from (
select 
 tp.id, ed.data_type,
WMSYS.WM_CONCAT (to_char( ed.edit_date,'YYYY-MM-DD HH24:MI:SS')) over( partition by TP.id order by ed.edit_date) edit_date,

WMSYS.WM_CONCAT (ed. edit_action) over(partition by tp.id order by ed.edit_date) edit_action

 from KG_data_audit_log tp
left join kg_data_audit_detail detail on TP.id=detail.data_audit_id
left join KG_EDIT_DATA ed on detail.data_edit_id=ed.id
left join pf_user uu on ed.EDIT_USER=uu.user_id
) tp1 left join

(
select 
 tp.id, 

WMSYS.WM_CONCAT (ed. edit_data_id) over(partition by tp.id order by ed.edit_date) edit_data_id,
WMSYS.WM_CONCAT (uu. user_name) over(partition by tp.id order by ed.edit_date) user_name

 from KG_data_audit_log tp
left join kg_data_audit_detail detail on TP.id=detail.data_audit_id
left join KG_EDIT_DATA ed on detail.data_edit_id=ed.id
left join pf_user uu on ed.EDIT_USER=uu.user_id
) tp2 on tp1.id=tp2.id
left join (
select 
 tp.id, 

	WMSYS.WM_CONCAT (ed. edit_user) over(partition by tp.id order by ed.edit_date) edit_user

 from KG_data_audit_log tp
left join kg_data_audit_detail detail on TP.id=detail.data_audit_id
left join KG_EDIT_DATA ed on detail.data_edit_id=ed.id
left join pf_user uu on ed.EDIT_USER=uu.user_id
) tp3 on tp3.id=tp1.id




 ) tp  where 1=1   group by id
 
			) tp2 on c.id=tp2.tid
			
			where 1=1 
			
			
		
		
		<if test="auditUser != null and auditUser !='' ">

			AND c.audit_User = #{auditUser}

		</if>
		
			
		<if test="auditState != null and auditState !='' ">

			AND c.audit_State = #{auditState}

		</if>
		
		
		order by c.audit_date desc
		
	
	</select>

</mapper>