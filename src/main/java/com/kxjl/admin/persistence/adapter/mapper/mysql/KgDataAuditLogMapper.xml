<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kxjl.admin.persistence.adapter.dao.KgDataAuditLogMapperAdapter">
    <!-- <resultMap id="BaseResultMap"
               type="com.kxjl.admin.persistence.entity.KgDataAuditLog"
               extends="com.kxjl.admin.persistence.dao.KgDataAuditLogMapper.BaseResultMap">
    </resultMap>
    
    
      <resultMap id="EdataBaseResultMap"
               type="com.kxjl.admin.persistence.entity.KgEditData"
               extends="com.kxjl.admin.persistence.dao.KgEditDataMapper.BaseResultMap">
    </resultMap>
     -->
    
     <!--在此编写自己的sql, 生成的sql文件不需要编辑-->


	<select id="selectList" databaseId="mysql"
		parameterType="com.kxjl.admin.persistence.entity.KgDataAuditLog"
		resultMap="BaseResultMap">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Mon Jun 08 
			11:51:06 CST 2020. -->
	
	
		select c.*,tp2.* from KG_data_audit_log c
			
			left join (
			
	
			
			SELECT
	tp.id tid,
	ed.data_type dataType,
	GROUP_CONCAT(
		DATE_FORMAT(
			ed.edit_date,
			'%Y-%m-%d %H:%i:%s'
		)
		ORDER BY
			ed.edit_date
	) editUserDate,
	GROUP_CONCAT(
		uu.user_name
		ORDER BY
			ed.edit_date
	) editUserName,
	GROUP_CONCAT(
		ed.edit_user
		ORDER BY
			ed.edit_date
	) editUser,
	GROUP_CONCAT(
		ed.edit_action
		ORDER BY
			ed.edit_date
	) editAction,
	GROUP_CONCAT(
		ed.edit_data_id
		ORDER BY
			ed.edit_date
	) editDataId
FROM
	KG_data_audit_log tp
LEFT JOIN kg_data_audit_detail detail ON TP.id = detail.data_audit_id
LEFT JOIN KG_EDIT_DATA ed ON detail.data_edit_id = ed.id
LEFT JOIN pf_user uu ON ed.EDIT_USER = uu.user_id
GROUP BY
	tp.id,
	ed.data_type
 
			) tp2 on c.id=tp2.tid
			
			where 1=1 
			
			
		
		
		<if test="auditUser != null and auditUser !='' ">

			AND c.audit_User = #{auditUser}

		</if>
		
			
		<if test="auditState != null and auditState !='' ">

			AND c.audit_State = #{auditState}

		</if>
		
		
		order by c.audit_date desc
		
	
	</select>

</mapper>