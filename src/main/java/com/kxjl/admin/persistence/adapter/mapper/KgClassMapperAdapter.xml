<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="com.kxjl.admin.persistence.adapter.dao.KgClassMapperAdapter">

	<!-- <resultMap id="BaseResultMap" type="com.kxjl.admin.persistence.entity.KgClass"> 
		WARNING - @mbg.generated This element is automatically generated by MyBatis 
		Generator, do not modify. This element was generated on Mon Jun 08 11:51:06 
		CST 2020. <id column="ID" jdbcType="VARCHAR" property="id" /> <result column="CLS_NAME" 
		jdbcType="VARCHAR" property="clsName" /> <result column="SORT" jdbcType="DECIMAL" 
		property="sort" /> <result column="DIR_ID" jdbcType="VARCHAR" property="dirId" 
		/> <result column="ENABLED" jdbcType="CHAR" property="enabled" /> <result 
		column="DELETED" jdbcType="CHAR" property="deleted" /> <result column="VERSION" 
		jdbcType="VARCHAR" property="version" /> <result column="CREATED_TIME" jdbcType="TIMESTAMP" 
		property="createdTime" /> <result column="UPDATED_TIME" jdbcType="TIMESTAMP" 
		property="updatedTime" /> </resultMap> -->

	<resultMap id="BaseResultMap"
		type="com.kxjl.admin.persistence.entity.KgClass"
		extends="com.kxjl.admin.persistence.dao.KgClassMapper.BaseResultMap">
	</resultMap>
	<!--在此编写自己的sql, 生成的sql文件不需要编辑，分开管理 -->

	<select id="selectByName"  databaseId="oracle"
		parameterType="com.kxjl.admin.persistence.entity.KgClass"
		resultMap="BaseResultMap">
		select
		c.*,g.subGroupNames subName,p.cls_name
		parentName,tp.attrNames,tp.attrIds attrs
		,g.subGroupNames
		subNames,g.subGroupIds subIds
		from KG_CLASS c
		left join (
		select c.id
		,WMSYS.WM_CONCAT (kp.name) subGroupNames,WMSYS.WM_CONCAT(kp.id)
		subGroupIds from KG_CLASS c
		left join KG_OBJECT_SUB_GROUP op on
		c.id=op.obj_id
		left join KG_SUB_GROUP kp on op.sub_group_id=kp.id
		group
		by c.id
		) g on c.id=g.id
		left join KG_CLASS p on p.id=c.parent_id
		left
		join (
		select c.id ,WMSYS.WM_CONCAT (kp.name)
		attrNames,WMSYS.WM_CONCAT(kp.id)
		attrIds from KG_CLASS c
		left join
		KG_OBJECT_PROPERTY op on c.id=op.cls_id
		left join KG_PROPERTY kp on
		op.prop_id=kp.id
		group by c.id
		) tp on c.id=tp.id


		where 1=1 and
		c.deleted='0'

		<if test="clsName != null and clsName!='' ">

			AND c.cls_name= #{clsName}

		</if>

		<![CDATA[ and  rownum<=1 ]]>
		order by c.CREATED_TIME DESC
	</select>



	<select id="selectDetailById"  databaseId="oracle"
		parameterType="com.kxjl.admin.persistence.entity.KgClass"
		resultMap="BaseResultMap">
		select
		c.*,g.subGroupNames subName,p.cls_name
		parentName,tp.attrNames,tp.attrIds attrs
		,g.subGroupNames
		subNames,g.subGroupIds subIds
		from KG_CLASS c
		left join (
		select c.id
		,WMSYS.WM_CONCAT (kp.name) subGroupNames,WMSYS.WM_CONCAT(kp.id)
		subGroupIds from KG_CLASS c
		left join KG_OBJECT_SUB_GROUP op on
		c.id=op.obj_id
		left join KG_SUB_GROUP kp on op.sub_group_id=kp.id
		group
		by c.id
		) g on c.id=g.id
		left join KG_CLASS p on p.id=c.parent_id
		left
		join (
		select c.id ,WMSYS.WM_CONCAT (kp.name)
		attrNames,WMSYS.WM_CONCAT(kp.id)
		attrIds from KG_CLASS c
		left join
		KG_OBJECT_PROPERTY op on c.id=op.cls_id
		left join KG_PROPERTY kp on
		op.prop_id=kp.id
		group by c.id
		) tp on c.id=tp.id


		where 1=1 and
		c.deleted='0'

		AND c.id= #{id}



<if test="_databaseId =='oracle' " >
		<![CDATA[ 
		and  rownum<=1 
		]]>
		</if>

	<if test="_databaseId =='mysql' " >
		<![CDATA[ 
		limit 1
		]]>
		</if>

	</select>

	<sql id="selectAllClassTable" databaseId="oracle">

		(
		select c.ID, c.VERSION_ID, c.CLS_NAME,c.PROPERTIES, c.CODE, c.
		PARENT_ID,
		c.SORT, c. DIR_ID, c.DIR_CODE, c.ENABLED, c.DELETED,
		c.CREATED_USER, c.CREATED_TIME, c.remark, c.UPDATED_USER,
		c.UPDATED_TIME
		from KG_CLASS c
		<if test="curUser != null and curUser!='' ">
			UNION all
			(
			select c.ID, c.VERSION_ID,
			c.CLS_NAME,c.PROPERTIES, c.CODE, c. PARENT_ID,
			c.SORT, c. DIR_ID,
			c.DIR_CODE, c.ENABLED, c.DELETED,
			c.CREATED_USER, c.CREATED_TIME,
			c.remark, c.UPDATED_USER, c.UPDATED_TIME from
			KG_EDIT_CLASS c
			left join
			kg_edit_data e on c.id=e.edit_data_id
			where 1=1 and
			e.edit_user=#{curUser}
			and e.edit_action='1'
and e.audit_state in ('1','2') 
			)

		</if>
		)
	</sql>
	
	<sql id="selectAllSubTable" databaseId="oracle">

		(
		select
		c.ID, c.VERSION_ID, c.NAME, c.REMARK, c.CREATED_USER, c.CREATED_TIME, c.UPDATED_USER, c.UPDATED_TIME ,c. DELETED,c. ENABLED
		from KG_SUB_GROUP c
		
			<if test="curUser != null and curUser!='' ">
		union
		(
		select   c.ID, c.VERSION_ID, c.NAME, c.REMARK, c.CREATED_USER, c.CREATED_TIME, c.UPDATED_USER, c.UPDATED_TIME ,'0' DELETED,'1' ENABLED from 
		KG_EDIT_SUB_GROUP c
		left join kg_edit_data e on c.id=e.edit_data_id
		where 1=1 and e.edit_user=#{curUser}
		and e.edit_action='1'
		and e.audit_state in ('1','2') 
		)
		</if>
		)
	</sql>
	


	<sql id="selectAllPropertyTable" databaseId="oracle">

		(
		select c.ID, c.VERSION_ID, c.NAME, c.DATA_TYPE_RULE, c.EQUIVALENCE,
		c.REMARK, c.ENABLED, c.DELETED, c.CREATED_USER,
		c.CREATED_TIME,
		c.UPDATED_USER, c.UPDATED_TIME from
		KG_PROPERTY c
		<if test="curUser != null and curUser!='' ">
			union
			(
			select c.ID, c.VERSION_ID, c.NAME, c.DATA_TYPE_RULE,
			c.EQUIVALENCE,
			c.REMARK, c.ENABLED, c.DELETED, c.CREATED_USER,
			c.CREATED_TIME, c.UPDATED_USER, c.UPDATED_TIME from
			KG_EDIT_PROPERTY c
			left join kg_edit_data e on c.id=e.edit_data_id
			where 1=1 and
			e.edit_user=#{curUser}
			and e.edit_action='1'
			and e.audit_state in ('1','2') 
			)
		</if>
		)

	</sql>
	
<sql id="selectAllChildClsId" >
	
	
select C1.id from  <include refid="selectAllClassTable" /> c1 left join  <include refid="selectAllClassTable" /> c2 ON
				c1.id=c2.parent_id
				where C1.id=#{clsId}
union  

select C2.id from  <include refid="selectAllClassTable" /> c1 left join  <include refid="selectAllClassTable" /> c2 ON
				c1.id=c2.parent_id
				where C1.id=#{clsId}

union  
select C3.id from  <include refid="selectAllClassTable" /> c1 left join  <include refid="selectAllClassTable" /> c2 ON
				c1.id=c2.parent_id
				left join  <include refid="selectAllClassTable" /> c3 ON c2.id=c3.parent_id
				where C1.id=#{clsId}
		
union  

select C4.id from  <include refid="selectAllClassTable" /> c1 left join  <include refid="selectAllClassTable" /> c2 ON
				c1.id=c2.parent_id
				left join  <include refid="selectAllClassTable" /> c3 ON c2.id=c3.parent_id
					left join  <include refid="selectAllClassTable" /> c4 ON c3.id=c4.parent_id
				where C1.id=#{clsId}

union  

select C5.id from  <include refid="selectAllClassTable" /> c1 left join  <include refid="selectAllClassTable" /> c2 ON
				c1.id=c2.parent_id
				left join  <include refid="selectAllClassTable" /> c3 ON c2.id=c3.parent_id
				left join  <include refid="selectAllClassTable" /> c4 ON c3.id=c4.parent_id
				left join  <include refid="selectAllClassTable" /> c5 ON c4.id=c5.parent_id
				where C1.id=#{clsId}
			
			
	</sql>

	<select id="selectList"  databaseId="oracle"
		parameterType="com.kxjl.admin.persistence.entity.KgClass"
		resultMap="BaseResultMap">
		<!-- WARNING - @mbg.generated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Mon Jun 08 
			11:51:06 CST 2020. -->
		select
		c.ID, c.VERSION_ID, c.CLS_NAME,c.PROPERTIES, c.CODE, c.
		PARENT_ID, c.SORT,
		c. DIR_ID, c.DIR_CODE, c.ENABLED, c.DELETED,
		c.CREATED_USER, c.CREATED_TIME, c.remark, c.UPDATED_USER,
		c.UPDATED_TIME
		,g.subGroupNames subName,p.cls_name
		parentName,tp.attrNames,tp.attrIds
		attrs
		,g.subGroupNames
		subNames,g.subGroupIds subIds
		from
		<include refid="selectAllClassTable" />
		c
		left join (

		select id,max(name) subGroupNames,max(kid) subGroupIds
		from (
		select
		id,
		WMSYS.WM_CONCAT (tp. NAME) over(partition by id order
		by tp.kid) name,
		WMSYS.WM_CONCAT (tp. kid) over( partition by id order
		by tp.kid) kid
		from (
		select c.id,kp.name,kp.id kid
		FROM
		<include refid="selectAllClassTable" />
		c
		left join KG_OBJECT_SUB_GROUP op on c.id=op.obj_id
		left join
		<include refid="selectAllSubTable" />  kp on op.sub_group_id=kp.id
		) tp
		) tp where 1=1 group by id

		) g on c.id=g.id
		left join
		<include refid="selectAllClassTable" />
		p on p.id=c.parent_id
		left join (


		select id,max(name) attrNames,max(kid)
		attrIds from (
		select
		id,
		WMSYS.WM_CONCAT (tp. NAME) over(partition by id
		order by tp.kid) name,
		WMSYS.WM_CONCAT (tp. kid) over( partition by id
		order by tp.kid) kid
		from (
		select c.id,kp.name,kp.id kid
		FROM
		<include refid="selectAllClassTable" />
		c
		LEFT JOIN KG_OBJECT_PROPERTY op ON c. ID = op.cls_id
		LEFT JOIN
		<include refid="selectAllPropertyTable" />
		kp ON op.prop_id = kp. ID
		) tp
		) tp where 1=1 group by id


		) tp on
		c.id=tp.id

		where 1=1 and c.deleted='0'


		<if test="clsName != null and clsName!='' ">
			<bind name="clsName" value="'%' + clsName + '%'" />
			AND c.cls_name LIKE #{clsName}

		</if>

		<if test="querySubIds != null  ">

			AND (

			<foreach collection="querySubIds" item="id" index="index"
				open="" close="" separator=" or ">

				g.subGroupIds like '%${id}%'
			</foreach>
			or g.subGroupIds is null )

		</if>
		<if test="parentId != null and parentId !='' ">


			AND c.parent_id in (
			
				<include refid="selectAllChildClsId" />
			
		<!-- 	select DISTINCT C1.id from  <include refid="selectAllClassTable" /> c1
			left join <include refid="selectAllClassTable" /> c2 ON
			c1.id=c2.parent_id
			left join <include refid="selectAllClassTable" /> c3 ON
			c3.id=c2.parent_id
			left join <include refid="selectAllClassTable" /> c4 ON c4.id=c3.parent_id
			left
			join <include refid="selectAllClassTable" /> c5 ON c5.id=c4.parent_id
			left join <include refid="selectAllClassTable" /> c6 ON
			c6.id=c5.parent_id
			where C1.parent_id=#{parentId}
			or
			c2.PARENT_ID=#{parentId}
			or c3.PARENT_ID=#{parentId}
			or
			c4.PARENT_ID=#{parentId}
			or c5.PARENT_ID=#{parentId}
			or
			c6.PARENT_ID=#{parentId} -->
			)


		</if>

		<if test=" id != null and id !='' ">

			AND c.id = #{id}

		</if>


		order by c.CREATED_TIME desc,c.sort asc
	</select>

	<select id="getTreeData"  databaseId="oracle"
		parameterType="com.kxjl.admin.persistence.entity.KgClass"
		resultMap="BaseResultMap">


		select c.*,tp.nodenum from <include refid="selectAllClassTable" /> c
		left join
		(
		select distinct c.id as
		id, count(c2.id) nodenum
		,WMSYS.WM_CONCAT(c2.cls_name) nodenames from
		<include refid="selectAllClassTable" /> c join  <include refid="selectAllClassTable" />
		c2 on c2.parent_id=c.id
		where c.deleted='0' and
		c2.deleted='0'
		group by c.id

		) tp on c.id=tp.id
		left join (
		select c.id
		,WMSYS.WM_CONCAT (kp.name)
		subGroupNames,WMSYS.WM_CONCAT(kp.id)
		subGroupIds from <include refid="selectAllClassTable" /> c
		left join KG_OBJECT_SUB_GROUP op on
		c.id=op.obj_id
		left join  <include refid="selectAllSubTable" />   kp on op.sub_group_id=kp.id
		group
		by c.id
		) g on c.id=g.id
		where 1=1 and c.deleted='0'
		and c.PARENT_ID
		=#{id}
		<if test="dirId != null and dirId !='' ">
			<bind name="dirId" value="'%' + dirId + '%'" />
			AND ( g.subGroupIds like #{dirId} or g.subGroupIds is null )

		</if>


		order by c.sort asc

	</select>



</mapper>